<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PECR Compliance Checker - Sendwize</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #ffffff;
  line-height: 1.6;
  overflow-x: hidden;
}
.header {
  background: white;
  border-bottom: 1px solid #f0f0f0;
  padding: 20px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.logo-container { display: flex; align-items: center; gap: 12px; }
.brand-name { font-size: 24px; font-weight: 700; color: #1a1a1a; }
.score-badge {
  display: flex; align-items: center; gap: 15px; padding: 12px 24px;
  background: linear-gradient(135deg, #f0f0f0 0%, #e5e5e5 100%);
  border-radius: 25px; border: 2px solid #d1d5db; transition: all 0.3s ease;
}
.score { font-size: 28px; font-weight: 700; color: #666; transition: all 0.3s ease; }
.score-label { font-size: 13px; color: #666; font-weight: 600; }
.split-container { display: flex; min-height: calc(100vh - 81px); }
.left-panel {
  width: 35%; background: linear-gradient(165deg, #f97316 0%, #ea580c 100%);
  padding: 50px 40px; color: white; position: relative; overflow: hidden;
}
.left-panel::before {
  content: ''; position: absolute; top: -50%; right: -20%;
  width: 500px; height: 500px; background: rgba(255, 255, 255, 0.05);
  border-radius: 50%; animation: float 6s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}
.left-content { position: relative; z-index: 2; }
.panel-title { font-size: 28px; font-weight: 700; margin-bottom: 15px; line-height: 1.2; }
.panel-subtitle { font-size: 16px; opacity: 0.9; margin-bottom: 40px; line-height: 1.6; }
.progress-bar {
  background: rgba(255, 255, 255, 0.2); height: 8px; border-radius: 10px;
  overflow: hidden; margin-bottom: 15px; position: relative;
}
.progress-fill {
  height: 100%; background: white; border-radius: 10px;
  transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
  position: relative; overflow: hidden;
}
.progress-fill::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
  animation: wave 2s linear infinite;
}
@keyframes wave {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
.progress-text { font-size: 14px; opacity: 0.8; margin-bottom: 40px; }
.compliance-meter {
  margin-top: 50px; padding: 25px; background: rgba(255, 255, 255, 0.1);
  border-radius: 12px; backdrop-filter: blur(10px); position: relative; overflow: visible;
}
.meter-label {
  font-size: 12px; opacity: 0.7; margin-bottom: 15px;
  text-transform: uppercase; letter-spacing: 1px;
}
.circular-progress { position: relative; width: 140px; height: 140px; margin: 0 auto 15px; }
.circular-progress svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.progress-ring-bg { fill: none; stroke: rgba(255, 255, 255, 0.2); stroke-width: 10; }
.progress-ring {
  fill: none; stroke: white; stroke-width: 10; stroke-linecap: round;
  transition: stroke-dashoffset 1s cubic-bezier(0.65, 0, 0.35, 1);
  filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.4));
}
.meter-score {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;
}
.meter-number {
  font-size: 36px; font-weight: 700; line-height: 1;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;
}
@keyframes popUp {
  0% { transform: scale(1); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.meter-number.pop-up { animation: popUp 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
@keyframes dropDown {
  0% { transform: translateY(0); }
  50% { transform: translateY(5px); }
  100% { transform: translateY(0); }
}
.meter-number.drop-down { animation: dropDown 0.4s ease; }
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}
.compliance-meter.shake { animation: shake 0.4s ease; }
@keyframes glowPulse {
  0%, 100% { filter: drop-shadow(0 0 0px rgba(255, 255, 255, 0)); }
  50% { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)); }
}
.circular-progress.glow { animation: glowPulse 0.8s ease; }
.sparkle {
  position: absolute; width: 6px; height: 6px; background: white;
  border-radius: 50%; pointer-events: none; z-index: 100;
}
@keyframes sparkleRise {
  0% { transform: translate(0, 0) scale(1); opacity: 1; }
  100% { transform: translate(var(--tx), -50px) scale(0); opacity: 0; }
}
.sparkle.animate { animation: sparkleRise 1s ease-out forwards; }
@keyframes warningFlash {
  0%, 100% { background: rgba(255, 255, 255, 0.1); }
  50% { background: rgba(239, 68, 68, 0.3); }
}
.compliance-meter.warning { animation: warningFlash 0.6s ease; }
.meter-status {
  font-size: 11px; opacity: 0.8; margin-top: 6px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
}
.risk-indicators { display: flex; gap: 6px; margin-top: 15px; justify-content: center; }
.risk-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: rgba(255, 255, 255, 0.3); transition: all 0.3s ease;
}
.risk-dot.active {
  background: white; box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
  transform: scale(1.3); animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.right-panel {
  width: 65%; padding: 60px 80px; background: #fafafa; position: relative;
}
.form-wrapper { max-width: 600px; }
.question-container { animation: slideInRight 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(50px); }
  to { opacity: 1; transform: translateX(0); }
}
.question-meta {
  color: #f97316; font-size: 14px; font-weight: 600; margin-bottom: 15px;
  text-transform: uppercase; letter-spacing: 1px;
}
.question-text {
  font-size: 36px; font-weight: 700; color: #1a1a1a;
  margin-bottom: 20px; line-height: 1.3;
}
.tooltip-trigger {
  display: inline-block; width: 20px; height: 20px; background: #f97316;
  color: white; border-radius: 50%; text-align: center; line-height: 20px;
  font-size: 12px; margin-left: 10px; cursor: help; position: relative; vertical-align: super;
}
.tooltip {
  position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
  background: #1a1a1a; color: white; padding: 12px 16px; border-radius: 8px;
  font-size: 14px; font-weight: 400; white-space: normal; width: 250px;
  opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.tooltip::after {
  content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
  border: 6px solid transparent; border-top-color: #1a1a1a;
}
.tooltip-trigger:hover .tooltip { opacity: 1; }
.question-description { font-size: 17px; color: #666; margin-bottom: 40px; line-height: 1.6; }
input[type="text"], textarea {
  width: 100%; padding: 18px 20px; font-size: 16px; border: 2px solid #e5e5e5;
  border-radius: 10px; transition: all 0.3s ease; font-family: inherit; background: white;
}
input:focus, textarea:focus {
  outline: none; border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}
.option {
  padding: 20px 25px; border: 2px solid #e5e5e5; background: white; border-radius: 12px;
  cursor: pointer; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  text-align: left; font-size: 17px; font-weight: 500; color: #333;
  margin-bottom: 12px; position: relative;
}
.option:hover {
  border-color: #f97316; transform: translateX(5px); box-shadow: 0 4px 12px rgba(249, 115, 22, 0.1);
}
.option.selected {
  border-color: #f97316; background: #fff7ed; color: #1a1a1a; font-weight: 600;
  animation: bounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
@keyframes bounce {
  0%, 100% { transform: scale(1); }
  25% { transform: scale(1.05); }
  50% { transform: scale(0.95); }
  75% { transform: scale(1.02); }
}
.option.selected::after {
  content: '‚úì'; position: absolute; right: 25px; top: 50%; transform: translateY(-50%);
  color: #f97316; font-size: 20px; font-weight: bold; animation: checkmark 0.3s ease;
}
@keyframes checkmark {
  0% { opacity: 0; transform: translateY(-50%) scale(0); }
  100% { opacity: 1; transform: translateY(-50%) scale(1); }
}
.buttons { display: flex; gap: 15px; margin-top: 50px; }
button {
  padding: 16px 32px; font-size: 16px; border: none; border-radius: 10px;
  cursor: pointer; transition: all 0.3s ease; font-weight: 600; font-family: inherit;
  position: relative; overflow: hidden;
}
button::before {
  content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
  border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}
button:active::before { width: 300px; height: 300px; }
.btn-primary {
  background: #f97316; color: white; flex: 1; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}
.btn-primary:hover {
  background: #ea580c; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(249, 115, 22, 0.4);
}
.btn-primary:disabled {
  background: #d1d5db; cursor: not-allowed; transform: none; box-shadow: none;
}
.btn-secondary {
  background: white; color: #666; border: 2px solid #e5e5e5; min-width: 120px;
}
.btn-secondary:hover { background: #f9f9f9; border-color: #d1d5db; }
.keyboard-hint {
  position: fixed; bottom: 20px; right: 20px; background: #1a1a1a; color: white;
  padding: 12px 20px; border-radius: 8px; font-size: 13px; opacity: 0.7;
  transition: opacity 0.3s ease; z-index: 50;
}
.keyboard-hint:hover { opacity: 1; }
.kbd {
  background: #333; padding: 2px 8px; border-radius: 4px; font-family: monospace; margin: 0 4px;
}
.loading { display: none; text-align: center; padding: 100px 40px; }
.loading.active { display: block; }
.spinner {
  border: 4px solid #f3f3f3; border-top: 4px solid #f97316; border-radius: 50%;
  width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 25px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.result { display: none; text-align: center; padding: 80px 40px; }
.result.active { display: block; }
.result-icon { font-size: 70px; margin-bottom: 25px; }
.result-title { font-size: 36px; font-weight: 700; margin-bottom: 20px; }
.result-message { font-size: 18px; color: #666; margin-bottom: 40px; line-height: 1.6; }
.confetti {
  position: fixed; width: 10px; height: 10px; background: #f97316; position: absolute;
  animation: confetti-fall 3s linear forwards; z-index: 9999;
}
@keyframes confetti-fall {
  to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}
.mini-confetti { position: absolute; width: 8px; height: 8px; border-radius: 50%; z-index: 150; }
@keyframes miniConfettiBurst {
  0% { transform: translate(0, 0) scale(1); opacity: 1; }
  100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
}
.mini-confetti.burst { animation: miniConfettiBurst 0.8s ease-out forwards; }
@media (max-width: 968px) {
  .split-container { flex-direction: column; }
  .left-panel, .right-panel { width: 100%; }
  .left-panel { padding: 40px 30px; }
  .right-panel { padding: 40px 30px; }
  .question-text { font-size: 28px; }
}
</style>
</head>
<body>
<div class="header">
  <div class="logo-container">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 200 200">
      <path d="M0 0 C163.02 0 326.04 0 494 0 C494 31.35 494 62.7 494 95 C330.98 95 167.96 95 0 95 C0 63.65 0 32.3 0 0 Z " fill="#FCFCFB" transform="translate(0,0)"/>
      <path d="M0 0 C6.6 0 13.2 0 20 0 C20 25.41 20 50.82 20 77 C15.05 77 10.1 77 5 77 C4.67 75.35 4.34 73.7 4 72 C2.9275 72.61875 1.855 73.2375 0.75 73.875 C-0.49448778 74.59297372 -1.74478166 75.30095564 -3 76 C-3.57492188 76.36867188 -4.14984375 76.73734375 -4.7421875 77.1171875 C-8.07303885 78.4195619 -11.3530687 78.28877356 -14.875 78.25 C-15.56980469 78.25773437 -16.26460937 78.26546875 -16.98046875 78.2734375 C-25.28095239 78.24217391 -31.03397 75.58469612 -37 70 C-43.48568277 61.79896032 -44.97889703 53.28446139 -44 43 C-41.65526128 33.73511348 -37.00062432 27.87002512 -28.8671875 22.98046875 C-24.81918227 20.85484257 -21.32298392 20.80428867 -16.8125 20.75 C-15.54019531 20.72421875 -14.26789063 20.6984375 -12.95703125 20.671875 C-9 21 -9 21 -1 24 C-0.67 16.08 -0.34 8.16 0 0 Z " fill="#EE973F" transform="translate(226,10)"/>
      <path d="M0 0 C6.93 0 13.86 0 21 0 C24.66059603 8.57625355 27.93971252 17.19679005 31 26 C32.83924204 23.24113694 33.81462726 21.02578385 34.91015625 17.9296875 C35.26013672 16.95128906 35.61011719 15.97289062 35.97070312 14.96484375 C36.33099609 13.94519531 36.69128906 12.92554688 37.0625 11.875 C37.78003304 9.85066785 38.49995563 7.82718055 39.22265625 5.8046875 C39.53984619 4.90733887 39.85703613 4.00999023 40.18383789 3.08544922 C41 1 41 1 42 0 C44.69654854 -0.07319621 47.36691458 -0.09242537 50.0625 -0.0625 C50.82111328 -0.05798828 51.57972656 -0.05347656 52.36132812 -0.04882812 C54.24091871 -0.0370068 56.12046899 -0.01907078 58 0 C58.2673999 0.74685059 58.5347998 1.49370117 58.81030273 2.26318359 C60.0180808 5.63425204 61.22776589 9.00463303 62.4375 12.375 C62.85837891 13.550625 63.27925781 14.72625 63.71289062 15.9375 C64.11572266 17.05898438 64.51855469 18.18046875 64.93359375 19.3359375 C65.4913147 20.89127197 65.4913147 20.89127197 66.06030273 22.47802734 C66.92952058 24.94802049 66.92952058 24.94802049 68 27 C68.2673999 26.25314941 68.5347998 25.50629883 68.81030273 24.73681641 C70.0180808 21.36574796 71.22776589 17.99536697 72.4375 14.625 C72.85837891 13.449375 73.27925781 12.27375 73.71289062 11.0625 C74.11572266 9.94101562 74.51855469 8.81953125 74.93359375 7.6640625 C75.30540771 6.62717285 75.67722168 5.5902832 76.06030273 4.52197266 C77 2 77 2 78 0 C84.93 0 91.86 0 99 0 C95.625 11.25 95.625 11.25 94.09887695 15.26611328 C93.75875076 16.16629181 93.41862457 17.06647034 93.06819153 17.993927 C92.53363594 19.39298782 92.53363594 19.39298782 91.98828125 20.8203125 C91.61519333 21.80498505 91.24210541 22.78965759 90.85771179 23.8041687 C89.67919847 26.91234758 88.49593566 30.01869242 87.3125 33.125 C86.50684522 35.24727581 85.7015037 37.36967057 84.89648438 39.4921875 C82.9346061 44.66283963 80.96846969 49.83185383 79 55 C72.73 55 66.46 55 60 55 C56.7 46.09 53.4 37.18 50 28 C45.90669983 37.7886857 45.90669983 37.7886857 42.25 47.6875 C40.10684474 53.89315526 40.10684474 53.89315526 39 55 C37.65732587 55.08631874 36.31025678 55.10706473 34.96484375 55.09765625 C34.15595703 55.09443359 33.34707031 55.09121094 32.51367188 55.08789062 C31.66353516 55.07951172 30.81339844 55.07113281 29.9375 55.0625 C29.08349609 55.05798828 28.22949219 55.05347656 27.34960938 55.04882812 C25.23304337 55.03700373 23.11651315 55.01906769 21 55 C16.19768381 45.24323821 12.54715253 35.04322648 8.78686523 24.85351562 C7.67679436 21.84599515 6.56055254 18.8408187 5.44335938 15.8359375 C4.73662372 13.92981925 4.03023065 12.02357394 3.32421875 10.1171875 C2.82277596 8.76583206 2.82277596 8.76583206 2.311203 7.38717651 C2.00700943 6.56186432 1.70281586 5.73655212 1.3894043 4.88623047 C1.12024704 4.15773895 0.85108978 3.42924744 0.57377625 2.67868042 C0 1 0 1 0 0 Z " fill="#EE973F" transform="translate(248,32)"/>
    </svg>
    <span class="brand-name">sendwize</span>
  </div>
  <div class="score-badge" id="headerBadge">
    <div class="score" id="headerScore">0%</div>
    <div class="score-label">Questions Answered</div>
  </div>
</div>
<div class="split-container">
  <div class="left-panel">
    <div class="left-content">
      <h1 class="panel-title">PECR Compliance Check</h1>
      <p class="panel-subtitle">Complete the assessment to check your campaign.</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <p class="progress-text" id="progressText">Not started</p>
      <div class="compliance-meter" id="complianceMeter">
        <div class="meter-label">Compliance Score</div>
        <div class="circular-progress" id="circularProgress">
          <svg viewBox="0 0 140 140">
            <circle class="progress-ring-bg" cx="70" cy="70" r="60"/>
            <circle class="progress-ring" id="progressRing" cx="70" cy="70" r="60" stroke-dasharray="376.99" stroke-dashoffset="376.99"/>
          </svg>
          <div class="meter-score">
            <div class="meter-number" id="meterNumber">0%</div>
            <div class="meter-status" id="meterStatus">Pending</div>
          </div>
        </div>
        <div class="risk-indicators">
          <div class="risk-dot" id="risk1"></div>
          <div class="risk-dot" id="risk2"></div>
          <div class="risk-dot" id="risk3"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="right-panel">
    <div class="form-wrapper" id="formContent"></div>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Analyzing your campaign compliance...</p>
    </div>
    <div class="result" id="result">
      <div class="result-icon" id="resultIcon"></div>
      <h2 class="result-title" id="resultTitle"></h2>
      <p class="result-message" id="resultMessage"></p>
      <button class="btn-primary" onclick="backToDashboard()">Back to Dashboard</button>
    </div>
  </div>
</div>
<div class="keyboard-hint">
  <kbd>Enter</kbd> Next ‚Ä¢ <kbd>‚Üê</kbd> Back ‚Ä¢ <kbd>Esc</kbd> Cancel
</div>
<script src="https://api.memberstackapp.com/static/memberstack.js?custom" data-memberstack-id="app_cmk1jc5fs00ry0ssb70vgbz3r"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const redirectUrl = urlParams.get('redirect') || 'https://new-mvp-v2.webflow.io';
const userId = urlParams.get('userId'); // Get user ID from URL

// COMPLETE QUESTION FLOW WITH CONDITIONAL LOGIC
let currentQuestionId = 'q1';
let answers = {};
let questionPath = [];
let previousScore = 0;
let totalQuestionsAsked = 0;

const questions = {
  q1: {
    id: 'q1',
    text: 'What is the name of your campaign?',
    type: 'text',
    getNext: () => 'q2',
    weight: 0
  },
  
  q2: {
    id: 'q2',
    text: 'Are you sure this is marketing?',
    type: 'choice',
    tooltip: "Marketing includes any communication promoting products, services, or ideals",
    options: [
      { value: 'yes', label: 'Yes' },
      { value: 'no', label: 'No' },
      { value: 'unsure', label: 'Unsure' }
    ],
    getNext: (answer) => {
      if (answer === 'yes') return 'q5';  // SKIP to Q5
      if (answer === 'no') return 'q3';
      return 'q4';
    },
    weight: 15
  },
  
  q3: {
    id: 'q3',
    text: 'Which of the following describes your communication?',
    type: 'choice',
    options: [
      { value: 'service', label: 'Service messages (payment reminder, password reset)' },
      { value: 'research', label: 'Market research with no promotional intent' },
      { value: 'admin', label: 'Administrative messages only' },
      { value: 'regulatory', label: 'Required by law' },
      { value: 'none', label: 'None of these apply' }
    ],
    getNext: (answer) => {
      if (answer === 'service' || answer === 'research' || answer === 'admin' || answer === 'regulatory') {
        return 'STOP_NOT_MARKETING';
      }
      return 'q4';
    },
    weight: 10
  },
  
  q4: {
    id: 'q4',
    text: 'Does your communication do ANY of the following?',
    type: 'multichoice',
    tooltip: "Select all that apply - even one YES means it is marketing",
    options: [
      { value: 'commercial', label: 'Market products/services' },
      { value: 'promote', label: 'Promote aims/ideals (fundraising, political)' },
      { value: 'encourage', label: 'Encourage using a service/special offer' },
      { value: 'promotional', label: 'Include promotional elements' },
      { value: 'none', label: 'None of these' }
    ],
    getNext: (answer) => {
      if (Array.isArray(answer) && answer.includes('none')) {
        return 'STOP_NOT_MARKETING';
      }
      return 'q5';
    },
    weight: 15
  },
  
  q5: {
    id: 'q5',
    text: 'What marketing channel are you using?',
    type: 'choice',
    tooltip: "Different channels have different PECR rules",
    options: [
      { value: 'email', label: 'Email' },
      { value: 'sms', label: 'SMS/Text Message' },
      { value: 'phone', label: 'Phone Call' },
      { value: 'fax', label: 'Fax' },
      { value: 'post', label: 'Postal Mail' }
    ],
    getNext: () => 'q6',
    weight: 10
  },
  
  q6: {
    id: 'q6',
    text: 'Do you have explicit consent from recipients?',
    type: 'choice',
    tooltip: "Consent must be freely given, specific, informed, and unambiguous",
    description: 'PECR requires explicit consent for electronic marketing.',
    options: [
      { value: 'yes', label: 'Yes, we have documented consent' },
      { value: 'no', label: 'No' },
      { value: 'unsure', label: "I am not sure" }
    ],
    getNext: (answer) => {
      if (answer === 'yes') return 'q7';
      return 'q8';  // Still continue to see other issues
    },
    weight: 25  // CRITICAL
  },
  
  q7: {
    id: 'q7',
    text: 'How was consent obtained?',
    type: 'choice',
    tooltip: "Only opt-in (unchecked by default) is truly compliant",
    options: [
      { value: 'opt-in', label: 'Clear opt-in checkbox (unchecked by default)' },
      { value: 'pre-ticked', label: 'Pre-ticked box' },
      { value: 'implied', label: 'Implied consent' },
      { value: 'purchased', label: 'Purchased list' }
    ],
    getNext: () => 'q8',
    weight: 20  // CRITICAL
  },
  
  q8: {
    id: 'q8',
    text: 'Does your message include a clear way to opt-out?',
    type: 'choice',
    tooltip: "Must be simple, free and immediate (e.g., unsubscribe link)",
    description: 'Every marketing message must include an easy unsubscribe method.',
    options: [
      { value: 'yes', label: 'Yes, clear and easy' },
      { value: 'no', label: 'No' }
    ],
    getNext: () => 'q9',
    weight: 15
  },
  
  q9: {
    id: 'q9',
    text: 'Does your message clearly identify who is sending it?',
    type: 'choice',
    tooltip: "Must include your organization name and valid contact details",
    options: [
      { value: 'yes', label: 'Yes, sender is clearly identified' },
      { value: 'no', label: 'No' }
    ],
    getNext: () => 'q10',
    weight: 10
  },
  
  q10: {
    id: 'q10',
    text: 'Do you have a lawful basis for processing personal data under GDPR?',
    type: 'choice',
    tooltip: 'Under GDPR, you need a legal reason to process personal data',
    options: [
      { value: 'yes', label: 'Yes, documented lawful basis' },
      { value: 'no', label: 'No' },
      { value: 'unsure', label: 'Unsure' }
    ],
    getNext: () => 'COMPLETE',
    weight: 15
  }
};

// SMART COMPLIANCE SCORING
function calculateCompliance() {
  let score = 0;
  let maxPossibleScore = 0;
  let criticalIssues = [];
  
  questionPath.forEach(qId => {
    const q = questions[qId];
    if (!q || q.weight === 0) return;
    
    maxPossibleScore += q.weight;
    const answer = answers[qId];
    
    // Q2: Is marketing?
    if (qId === 'q2' && answer === 'yes') {
      score += q.weight;
    }
    
    // Q6: Has consent? (CRITICAL)
    if (qId === 'q6') {
      if (answer === 'yes') {
        score += q.weight;
      } else {
        criticalIssues.push('No consent');
      }
    }
    
    // Q7: Consent method (CRITICAL)
    if (qId === 'q7') {
      if (answer === 'opt-in') {
        score += q.weight;
      } else if (answer === 'purchased') {
        criticalIssues.push('Purchased list');
        score -= 10;  // PENALTY
      } else {
        criticalIssues.push('Invalid consent method');
      }
    }
    
    // Q8: Has opt-out?
    if (qId === 'q8') {
      if (answer === 'yes') {
        score += q.weight;
      } else {
        criticalIssues.push('No opt-out');
      }
    }
    
    // Q9: Sender identified?
    if (qId === 'q9') {
      if (answer === 'yes') {
        score += q.weight;
      } else {
        criticalIssues.push('Sender not identified');
      }
    }
    
    // Q10: Lawful basis?
    if (qId === 'q10') {
      if (answer === 'yes') {
        score += q.weight;
      } else {
        criticalIssues.push('No lawful basis');
      }
    }
  });
  
  // Calculate percentage
  const percentage = maxPossibleScore > 0 ? Math.round((score / maxPossibleScore) * 100) : 0;
  
  return {
    score: Math.max(0, Math.min(100, percentage)),
    criticalIssues: criticalIssues
  };
}

function updateComplianceMeter() {
  const compliance = calculateCompliance();
  const score = compliance.score;
  
  const circumference = 376.99;
  const offset = circumference - (score / 100) * circumference;
  document.getElementById('progressRing').style.strokeDashoffset = offset;
  
  const meterNumber = document.getElementById('meterNumber');
  meterNumber.textContent = Math.round(score) + '%';
  
  // Animations
  const scoreIncreased = score > previousScore;
  const scoreDecreased = score < previousScore;
  
  if (scoreIncreased && previousScore > 0) {
    meterNumber.classList.add('pop-up');
    setTimeout(() => meterNumber.classList.remove('pop-up'), 500);
    createSparkles();
    document.getElementById('circularProgress').classList.add('glow');
    setTimeout(() => document.getElementById('circularProgress').classList.remove('glow'), 800);
    
    if (score >= 25 && previousScore < 25) createMiniConfetti();
    if (score >= 50 && previousScore < 50) createMiniConfetti();
    if (score >= 75 && previousScore < 75) createMiniConfetti();
  } else if (scoreDecreased && previousScore > 0) {
    meterNumber.classList.add('drop-down');
    setTimeout(() => meterNumber.classList.remove('drop-down'), 400);
    const meter = document.getElementById('complianceMeter');
    meter.classList.add('shake');
    setTimeout(() => meter.classList.remove('shake'), 400);
    meter.classList.add('warning');
    setTimeout(() => meter.classList.remove('warning'), 600);
  }
  
  previousScore = score;
  
  // Status
  let status = 'At Risk';
  if (score >= 70) status = 'Compliant';
  else if (score >= 40) status = 'Needs Work';
  
  document.getElementById('meterStatus').textContent = status;
  
  // Risk indicators
  const risk1 = document.getElementById('risk1');
  const risk2 = document.getElementById('risk2');
  const risk3 = document.getElementById('risk3');
  risk1.classList.remove('active');
  risk2.classList.remove('active');
  risk3.classList.remove('active');
  
  if (score >= 70) risk3.classList.add('active');
  else if (score >= 40) risk2.classList.add('active');
  else risk1.classList.add('active');
}

function createSparkles() {
  const meter = document.getElementById('circularProgress');
  const rect = meter.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  
  for (let i = 0; i < 8; i++) {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle animate';
    sparkle.style.left = centerX + 'px';
    sparkle.style.top = centerY + 'px';
    const angle = (i / 8) * Math.PI * 2;
    const distance = 30 + Math.random() * 20;
    sparkle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
    document.body.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 1000);
  }
}

function createMiniConfetti() {
  const meter = document.getElementById('circularProgress');
  const rect = meter.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  const colors = ['#f97316', '#fb923c', '#fdba74', '#fff'];
  
  for (let i = 0; i < 20; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'mini-confetti burst';
    confetti.style.left = centerX + 'px';
    confetti.style.top = centerY + 'px';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    const angle = Math.random() * Math.PI * 2;
    const distance = 40 + Math.random() * 40;
    confetti.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
    confetti.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 800);
  }
}

function renderQuestion() {
  const q = questions[currentQuestionId];
  
  if (!q) {
    if (currentQuestionId === 'COMPLETE') {
      submit();
    } else if (currentQuestionId === 'STOP_NOT_MARKETING') {
      showStopMessage('This is NOT direct marketing', 'Based on your answers, this communication does not qualify as direct marketing under PECR. You do not need to complete this compliance check.');
    }
    return;
  }
  
  let html = '<div class="question-container">';
  html += `<div class="question-meta">Question ${questionPath.length + 1}</div>`;
  html += `<h2 class="question-text">${q.text}`;
  
  if (q.tooltip) {
    html += `<span class="tooltip-trigger">?<span class="tooltip">${q.tooltip}</span></span>`;
  }
  
  html += '</h2>';
  
  if (q.description) {
    html += `<p class="question-description">${q.description}</p>`;
  }
  
  if (q.type === 'text') {
    const value = answers[q.id] || '';
    html += `<input type="text" id="answer" value="${value}" placeholder="Type here..." autofocus />`;
  } else if (q.type === 'choice') {
    q.options.forEach(opt => {
      const selected = answers[q.id] === opt.value ? 'selected' : '';
      html += `<div class="option ${selected}" onclick="selectOption('${opt.value}')">${opt.label}</div>`;
    });
  } else if (q.type === 'multichoice') {
    q.options.forEach(opt => {
      const selected = answers[q.id] && answers[q.id].includes(opt.value) ? 'selected' : '';
      html += `<div class="option ${selected}" onclick="selectMultiOption('${opt.value}')">${opt.label}</div>`;
    });
  }
  
  html += `
    <div class="buttons">
      ${questionPath.length > 0 ? '<button class="btn-secondary" onclick="previous()">‚Üê Back</button>' : '<button class="btn-secondary" onclick="cancel()">Cancel</button>'}
      <button class="btn-primary" id="nextBtn" onclick="next()" ${!answers[q.id] ? 'disabled' : ''}>Next ‚Üí</button>
    </div>
  </div>`;
  
  document.getElementById('formContent').innerHTML = html;
  
  if (q.type === 'text') {
    const input = document.getElementById('answer');
    input.oninput = (e) => {
      answers[q.id] = e.target.value;
      document.getElementById('nextBtn').disabled = !e.target.value.trim();
    };
  }
  
  updateProgress();
  updateComplianceMeter();
}

function selectOption(value) {
  const q = questions[currentQuestionId];
  answers[q.id] = value;
  renderQuestion();
}

function selectMultiOption(value) {
  const q = questions[currentQuestionId];
  if (!answers[q.id]) answers[q.id] = [];
  
  const idx = answers[q.id].indexOf(value);
  if (idx > -1) {
    answers[q.id].splice(idx, 1);
  } else {
    answers[q.id].push(value);
  }
  
  if (answers[q.id].length === 0) delete answers[q.id];
  renderQuestion();
}

function updateProgress() {
  const answered = questionPath.length;
  const pct = Math.min(100, Math.round((answered / 10) * 100));
  
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = answered === 0 ? 'Not started' : `${answered} questions answered`;
  document.getElementById('headerScore').textContent = pct + '%';
}

function next() {
  const q = questions[currentQuestionId];
  if (!q) return;
  
  questionPath.push(currentQuestionId);
  totalQuestionsAsked++;
  
  const answer = answers[q.id];
  const nextId = q.getNext ? q.getNext(answer) : null;
  
  if (nextId) {
    currentQuestionId = nextId;
    renderQuestion();
  }
}

function previous() {
  if (questionPath.length === 0) return;
  
  const prevId = questionPath.pop();
  delete answers[prevId];
  
  currentQuestionId = questionPath.length > 0 ? questionPath[questionPath.length - 1] : 'q1';
  questionPath.pop();
  
  renderQuestion();
}

function cancel() {
  if (confirm('Cancel this check? Progress will be lost.')) {
    backToDashboard();
  }
}

function showStopMessage(title, message) {
  document.getElementById('formContent').style.display = 'none';
  document.getElementById('result').classList.add('active');
  document.getElementById('resultIcon').textContent = '‚ÑπÔ∏è';
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultTitle').style.color = '#3b82f6';
  document.getElementById('resultMessage').textContent = message;
}

function createConfetti() {
  const colors = ['#f97316', '#ea580c', '#fb923c', '#fdba74'];
  for (let i = 0; i < 100; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3000);
    }, i * 30);
  }
}

async function submit() {
  document.getElementById('formContent').style.display = 'none';
  document.getElementById('loading').classList.add('active');
  
  try {
    // Get user ID from URL (passed from Webflow dashboard)
    if (!userId) {
      alert('Please log in to save your results.');
      backToDashboard();
      return;
    }
    
    console.log('User ID from URL:', userId);
    
    const compliance = calculateCompliance();
    let finalResult;
    
    if (compliance.criticalIssues.includes('No consent') || compliance.criticalIssues.includes('Purchased list')) {
      finalResult = 'STOP AND RE-THINK THIS CAMPAIGN';
    } else if (compliance.score >= 70) {
      finalResult = 'Send this Wizely';
    } else {
      finalResult = 'Not Wize to send';
    }
    
    await fetch('/api/submit-check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        records: [{
          fields: {
            UserID: userId,
            CampaignName: answers.q1 || 'Unnamed Campaign',
            SubmissionDate: new Date().toISOString().split('T')[0],
            Result: finalResult,
            Score: compliance.score,
            Answers: JSON.stringify(answers)
          }
        }]
      })
    });
    
    showResult(finalResult, compliance.score);
    createConfetti();
    
  } catch (error) {
    console.error('Submit error:', error);
    alert('Error: ' + error.message);
    document.getElementById('loading').classList.remove('active');
    document.getElementById('formContent').style.display = 'block';
  }
}

function showResult(result, score) {
  document.getElementById('loading').classList.remove('active');
  document.getElementById('result').classList.add('active');
  
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  const msg = document.getElementById('resultMessage');
  
  if (result === 'Send this Wizely') {
    icon.textContent = '‚úÖ';
    title.textContent = 'Compliant!';
    title.style.color = '#10b981';
    msg.textContent = `Your campaign scored ${Math.round(score)}% and appears to be PECR compliant. You can proceed with confidence.`;
  } else if (result === 'STOP AND RE-THINK THIS CAMPAIGN') {
    icon.textContent = '‚ö†Ô∏è';
    title.textContent = 'Stop!';
    title.style.color = '#f59e0b';
    msg.textContent = `Your campaign scored ${Math.round(score)}%. Critical issues detected - you must address these before sending.`;
  } else {
    icon.textContent = '‚ùå';
    title.textContent = 'Not Compliant';
    title.style.color = '#ef4444';
    msg.textContent = `Your campaign scored ${Math.round(score)}% and does not meet PECR requirements. Please make changes before proceeding.`;
  }
}

function backToDashboard() {
  window.location.href = redirectUrl;
}

document.addEventListener('keydown', (e) => {
  if (document.activeElement.tagName === 'INPUT') {
    if (e.key === 'Enter') {
      e.preventDefault();
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn && !nextBtn.disabled) next();
    }
    return;
  }
  
  if (e.key === 'Enter') {
    e.preventDefault();
    const nextBtn = document.getElementById('nextBtn');
    if (nextBtn && !nextBtn.disabled) next();
  }
  if (e.key === 'ArrowLeft' && questionPath.length > 0) {
    e.preventDefault();
    previous();
  }
  if (e.key === 'Escape') {
    e.preventDefault();
    cancel();
  }
});

function init() {
  console.log('üöÄ Starting PECR compliance checker with conditional logic...');
  renderQuestion();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
